

- 单一数据库节点面临的问题
    - 难以支持海量数据存储和高并发查询请求
        - 从性能方面来说，由于关系型数据库大多采用 B+树类型的索引，在数据量逐渐增大的情况下，索引深度的增加也将使得磁盘访问的 IO 次数增加，进而导致查询性能的下降；同时，高并发访问请求也使得集中式数据库成为系统的最大瓶颈
    - 解决方法
        - 在原有关系型数据库的基础上做增量
            - 分库分表方案，使之更好适应海量数据存储和高并发查询请求的场景
                - 产生的问题
                    - 查询时路由库和表，并聚合查询结果
                    - 多表关联查询、排序、分页、事务等等问题
                - Sharding-JDBC，尽量透明化水平分库分表所带来的影响，像查询单数据库实例和单表那样来查询被水平分割的库和表
        - 颠覆关系型数据库
            - 数据存储到原生支持分布式的数据库或NoSQL数据库
            
            
- 在分片的世界里，数据分片有两种法则：垂直拆分和水平拆分。
    - 垂直分片(纵向拆分)
        - 按照业务拆分，专库专用，按照业务将表进行归类，分布到不同的数据库中，从而将压力分散至不同的数据库
        - 无法真正的解决单点瓶颈。如果垂直拆分之后，表中的数据量依然超过单节点所能承载的阈值，则需要水平分片来进一步处理
    - 水平分片又称为横向拆分
        - 通过某个字段（或某几个字段），根据某种规则将数据分散至多个库或表中，每个分片仅包含数据的一部分，使得各个表的数据量保持在阈值以下，是应对高并发和海量数据系统的有效手段
        - 从理论上突破了单机数据量处理的瓶颈，并且扩展相对自由，是分库分表的标准解决方案
        - 水平分库本质上还是在分表，因为被水平拆分后的库中，都有相同的表分片
        - sharing-jdbc
            - 尽量透明化水平分库分表所带来的影响，让使用方尽量像使用一个数据库一样使用水平分片之后的数据库集群，或者像使用一个数据表一样使用水平分片之后的数据表
            - 每个服务器节点只能看到一个逻辑上的数据库节点，和其中的多个逻辑表，它们看不到真正存在于物理世界中的被水平分割的多个数据库分片和被水平分割的多个数据表分片

-  JDBC 层提供的额外服务，可以说是一个增强版的 JDBC 驱动，完全兼容 JDBC 和各种 ORM 框架
    - 完全兼容 JDBC
    - 用于任何基于 JDBC 的 ORM 框架
    - 支持任何第三方的数据库连接池，如：DBCP, C3P0, BoneCP, Druid, HikariCP
    - 支持任意实现 JDBC 规范的数据库
    
- 为透明化水平分库分表所带来的影响所做的处理
    - SQL 解析
        - 词法解析和语法解析理解SQL
    - SQL 路由
        - 根据库和表配置的分片策略生成路由后的 SQL，路由后的 SQL 有一条或多条，每一条都对应着各自的真实物理分片
    - SQL 改写
        - SQL 改写为在真实数据库中可以正确执行的语句，逻辑 SQL 到物理 SQL 的映射，例如把逻辑表名改成带编号的分片表名
    - SQL 执行
        - 多线程执行器异步执行 SQL 语句
    - 结果归并
        - 多个执行结果集归并以便于通过统一的 JDBC 接口输出
        
-  Groovy 表达式
    - - 对记录的读和写都按照这种方向进行，“方向”，就是分片方式，就是路由
```
ds$->{0..1}.t_order$->{0..1}
ds_${user_id % 2}
t_order_${order_id % 2}
```
    

- 对表两种维度的拆分
    - 数据库维度
        - 有人称这一过程为水平分库，其实它的本质还是在水平地分表，只不过依据表中 user_id 的不同把拆分后的表放入两个数据库实例
    - 表维度
        - t_order.order_id% 2 == 0 的记录全部落到 t_order0，t_order.order_id% 2 == 1 的记录全部落到 t_order1
    - 本质上是分成4张表，分成两组每组分到一个库
    
- 分片策略和分片算法
    - Groovy 表达式
    - 分片策略接口和分片算法接口表达更为复杂的分片策略和分片算法
    - 分片算法是分片策略的组成部分，分片策略设置=分片键设置+分片算法设置
    - 分片策略  
        - Inline 类型
        -  Inline 类型的行表达式算法
        
- 数据源
    - ShardingSphereDataSource 实现自 JDBC 的标准接口 DataSource
    - ShardingSphereDataSource包装了平常使用的数据源比如Druid，实际上通过ShardingSphereDataSource使用其他第三方的数据库连接池
    - 进而通过这个 ShardingSphereDataSource 调用原生 JDBC 接口来执行 SQL 查询，或者将 dataSource 配置到 JPA，MyBatis 等 ORM 框架来执行 SQL 查询
    - Java 代码调用 ShardingSphereDataSource 实例的 dataSource 的 JDBC 接口时，只感觉自己在对一个逻辑库中的两个逻辑表进行关联查询，并没有意识到物理分片的存在。而背后在进行 SQL 语句的解析、路由、改写、执行和结果归并