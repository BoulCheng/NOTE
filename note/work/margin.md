







1. 业务功能概览：期货交易系统保证金子系统：在市场价格随时间波动下，计算用户账户保证金是否充足，否则强平用户的仓位，及时止损避免用户资金亏损到负值导致其他用户或平台分摊亏损。

2. 总体设计：将需要处理的用户动态分配给分布式部署的各个机器上，支持水平扩展增加机器数量实现线性增加可以处理的总用户数，同时支持故障转移当某台机器故障时该台机器原本需要处理的用户会转移到其他机器处理，具有高性能、高可用、可水平扩展等特点。

3. 具体实现：
通过elastic-job分片特性，预先配置好分片总数，分片总数会根据分片策略被分配给各个机器，然后各个机器会根据最新获得的属于自己的分片数去找到要处理的一批用户，进而把这批用户分成多组，每组封装成一个task放入线程池处理，线程遍历一组用户中每个用户计算用户账户资金状况实行强制减仓处理；

每个机器启动时都会在zookeeper同一个父节点下写入一个临时节点，且会在该父节点注册子节点变更的Watcher，因此无论是在实行水平扩展增加机器或者机器故障时，所有机器都会收到节点变化的通知然后执行重新分片操作，更新每台机器的分片数，进而可以动态更新每台机器所需处理的用户数。

4. 后期优化：计算用户保证金时会获取用户相关信息，用户持仓信息，最新价格等再经过一系列复杂的保证金计算判断用户是否要爆仓处理，如果是则会下强平单实行强制减仓处理，更新用户信息，发送爆仓邮件短信给用户，发送爆仓mq消息给其他系统做记录及统计；其中涉及mysql、redis的访问、通过RPC及MQ与其他系统进行通信；
在优化时将不频繁变化的数据放入内存作为一级缓存，减少访问Redis的网络开销，部分RPC查询其他依赖系统的数据改为直接连接数据库查询减少网络开销，将爆仓后MQ消息和短信邮件的发送等非核心逻辑异步处理等。






公司产品是一个交易系统，开发区块链数字货币期货合约交易系统，主要负责的子系统有K线子系统、保证金子系统、全站交易数据推送子系统；

1. 保证金系统
独立负责从无到有的设计及开发，在市场价格随时间波动下，计算用户账户保证金是否充足，否则强平用户的仓位，及时止损避免用户资金亏损到负值导致其他用户或平台分摊亏损。
总体设计上将需要处理的用户动态分配给分布式部署的各个机器上，支持水平扩展增加机器数量实现线性增加可以处理的总用户数，同时支持故障转移当某台机器故障时该台机器原本需要处理的用户会转移到其他机器处理，具有高性能、高可用、可水平扩展等特点。
2. K线系统
独立负责从无到有的设计及开发，以在高并发交易时生成K线的高性能、高稳定性、数据一致性以及查询的高效为设计目标。
3. 全站交易数据推送系统
应用核心基础功能独立设计开发者，应用负责人，核心功能包括基于Netty实现WebSocket推送消息，WebSocket连接的维护等；其他开发人员在此基础上实现各模块各维度的数据推送业务仅仅只需关注业务数据的准备工作。主要解决的应用性能问题有CPU高过、内存溢出等。
4. 修改ElasticJob框架源码实现毫秒级别定时任务，并在全公司推行使用



附：
● 个人简介
1.阅读过J.U.C包、集合框架等大量JDK8源码; 理解线程池、AQS、ReentrantLock等源码;
2.贡献开源框架elastic-job源码、修改过框架源码应用于生产环境;
3.熟练JVM常用options配置进行应用性能调优, 熟练使用VisualVM分析应用性能以及排查CPU过高等问题;
4.理解自动内存管理、垃圾收集、类加载机制等; 理解GC过程，能使用mat分析内存泄漏溢出;
5.熟练各种数据结构：数组、栈、队列、链表、散列表、二叉搜索树、堆、红黑树等;
6.熟练掌握各种设计模式并能实际编程使用;
7.多个高并发、高可用、分布式应用独立开发者(PM)以及压测性能优化负责人;
8.熟练掌握Linux操作及编写Shell脚本;
9.阅读过Netty、Elastic-Job源码并理解其核心设计;
10.目前负责项目使用的技术栈：Netty、Elastic-Job、MySQL、Redis、Dubbo、ZooKeeper、Nginx、spring-cloud、RocketMQ、Docker、spring-boot、MyBatis; 
11.目前负责的项目均是分布式系统、微服务架构应用;
12.编程习惯优秀、代码规范、注重协作开发、负责组内代码review;
13.英文阅读能力良好，有阅读英文文档的习惯;
	
	
	
个人GitHub:
● JDK源码阅读注释笔记：https://github.com/BoulCheng/JDK8
● Elastic-Job源码阅读注释笔记：https://github.com/BoulCheng/elastic-job-2.1.5/tree/sourceCodeAnalysis
● Netty源码阅读注释笔记：https://github.com/BoulCheng/netty-4.1.36.Final/tree/develop
● Dubbo部分源码阅读注释笔记：https://github.com/BoulCheng/dubbo-2.6.4
● 设计模式Demo练习及心得总结笔记：https://github.com/BoulCheng/Head-First-Design-Patterns-Sample
● JVM笔记：https://github.com/BoulCheng/JVMS
● 算法Java实现练习代码：https://github.com/BoulCheng/algorithm-study
● elastic-job源码贡献 Pull requests : https://github.com/elasticjob/elastic-job-lite/pull/630











期货交易所保证金系统：市场价格随时间变动下，实时计算用户账户保证金是否充足，否则强平用户的仓位，及时止损。

保证金系统是一个独立应用，，为满足爆仓的实时性，同时修改了elastic-job框架源码支持毫秒级别定时任务。
elastic-job定时任务触发的间隔时间可以是任意毫秒数，任务触发时执行爆仓检测。
高可用：利用elastic-job分片特性，配置分片总数shardingTotalCount实现多机部署时故障转移
高并发：多机部署时，系统总用户量动态平均分给各个机器，每台机器再把该台机器需要处理爆仓检测的用户量分给一个线程池的各个线程处理，每个线程依次处理该线程需要爆仓检测的用户。
水平扩展：因为系统的总用户量是平均分给各台机器，增加机器时，可以分担每台机器需要检测爆仓的用户量
爆仓检测时会获取用户相关信息，用户持仓信息，最新价格等等再经过一系列非常复杂的业务计算判断用户是否爆仓，如果爆仓则会下强平单，更新用户信息，发送爆仓邮件短信给用户，发送爆仓mq消息给其他系统做记录及统计；其中涉及mysql、redis的访问，通过RPC及MQ与其他系统进行通信
性能压测优化：
1.更新少查询频繁即读大于写的基础数据如期货合约信息从数据库缓存到redis, 减少查询时间
2.RPC查询其他依赖系统的数据改为在保证金系统的应用直接连接数据库查询
3.爆仓后短信邮件的发送从爆仓线程移出到一个单独处理消息发送的线程池处理，因为发送短信邮件的过程存在RPC等会增加爆仓线程的处理时间的操作





具有高性能、高可用、可水平扩展特点

期货交易所保证金系统：在市场价格随时间变动下，计算用户账户保证金是否充足，否则强平用户的仓位，及时止损避免用户资金亏损到负值导致其他用户或平台分摊亏损

总体设计上将用户动态分配给分布式部署的各个机器上，支持水平扩展增加机器数量实现线性增加可以处理的总用户数，同时支持故障转移当某台机器故障时该台机器原本需要处理的用户会转移到其他机器处理
具体实现通过elastic-job分片特性，预先配置好分片总数，分片总数会根据分片策略被分配给各个机器，然后各个机器会根据最新获得的属于自己的分片数去找到要处理的一批用户，
进而把这批用户分成多组，每组封装成一个task放入线程池处理，线程遍历一组用户中每个用户计算用户账户资金状况实行强制减仓处理。

每个机器启动时都会在zookeeper同一个父节点下写入一个临时节点，且会在该父节点注册子节点变更的Watcher，因此无论是在实行水平扩展增加机器或者机器故障时，
所有机器都会收到节点变化的通知然后执行重新分片操作，更新每个机器的分片数，即达到了更新该机器处理的用户。

用户资金状况检测时会获取用户相关信息，用户持仓信息，最新价格等再经过一系列非常复杂的保证金计算判断用户是否爆仓，如果爆仓则会下强平单实行强制减仓处理，更新用户信息，发送爆仓邮件短信给用户，发送爆仓mq消息给其他系统做记录及统计；其中涉及mysql、redis的访问，通过RPC及MQ与其他系统进行通信
在优化时将不频繁变化的数据放入内存作为一级缓存，减少访问Redis的网络开销，部分RPC查询其他依赖系统的数据改为直接连接数据库查询减少网络开销，将爆仓后MQ消息和短信邮件的发送等非核心逻辑异步处理

应用具有高性能、高可用、可水平扩展的特点










#### 600

- elastic-job(任务的分布式协调，比较于微服务的分布式协调) 源码阅读及修改   1.想法 2.看框架源码原生的是怎样的 3.尽可能的在它原有的基础上扩展新功能 4.兼容复用它原来的配置

#### 水平扩展与高可用
- (应用)任务的水平扩展，数据分片到不同机器

- (应用)任务的高可用

#### 分布式数据一致性
- 分布式 数据操作并发安全问题 比如操作一个用户之前通过redis-setnx表示这个用户已经在被处理

#### 缓存
- 缓存先于rpc、数据库访问，分布式应用数据需要共享的可以使用缓存服务器如redis，一级内存缓存(单线程内频繁处理的数据)

#### 减少数据访问频次
- 减少rpc(批量数据rpc)、减少redis的访问、减少数据库的访问

#### 数据库
- 在并发要求极高的应用中直接查数据库，替代通过rpc查数据库
- 数据库读写分离，分表，分库

#### 多线程处理
- 多线程处理: 自定义线程池(线程池线程数如何确定？？？)，把批量数据切分到线程池中各个线程处理，在多线程处理前预先准备好数据，避免在各个线程中重复获取数据， CountDownLatch等待其他线程处理完
线程任务堆积导致的数据过期引发错误操作, 线程池最大线程数和队列大小设置不合理导致任务没有执行业务出错

#### 异步
- mq消息异步处理，外围业务比如短信通知, 也可以放在一个单独的线程池处理，与核心业务线程分开； 以及一些其他的异步rpc


#### 难点
- 实现业务逻辑极复杂的保证金风控策略
- 修改源码实现风控监测的实时性
- 高并发处理(缓存 rpc 多线程处理 异步处理 数据一致性问题)
- 保证系统的水平扩展功能
- 保证系统的高可用
- 


- 压测
    - 1000/5 = 200 * 4 = 800
    
    
    




elastic-job线程池单线程处理 直接拒绝task


- 2s内处理完
- 100000-200000 用户，50机器，每台机器2s要处理2000-4000个用户，每台机器1s要处理1000-2000个用户

单线程 20ms每个用户 1s处理50个用户
    -     
        两次redis访问
        查询用户信息(在最外层做 这里去掉)
        查询持仓信息
        rpc下单
        更新用户状态
单台机器1s要处理1000个用户

1000/50 = 20个线程数

再延迟500ms,0.5s

20 * 50 * 0.5 = 500个，

(2000 - 500)/50 = 30个线程池





------ 


附：
● 个人简介
1.阅读过J.U.C包、集合框架等大量JDK8源码; 理解线程池、AQS、ReentrantLock等源码;
2.贡献开源框架elastic-job源码、修改过框架源码应用于生产环境;
3.熟练JVM常用options配置进行应用性能调优, 熟练使用VisualVM分析应用性能以及排查CPU过高等问题;
4.理解自动内存管理、垃圾收集、类加载机制等; 理解GC过程，能使用mat分析内存泄漏溢出;
5.熟练各种数据结构：数组、栈、队列、链表、散列表、二叉搜索树、堆、红黑树等;
6.熟练掌握各种设计模式并能实际编程使用;
7.多个高并发、高可用、分布式应用独立开发者(PM)以及压测性能优化负责人;
8.熟练掌握Linux操作及编写Shell脚本;
9.阅读过Netty、Elastic-Job源码并理解其核心设计;
10.目前负责项目使用的技术栈：Netty、Elastic-Job、MySQL、Redis、Dubbo、ZooKeeper、Nginx、spring-cloud、RocketMQ、Docker、spring-boot、MyBatis; 
11.目前负责的项目均是分布式系统、微服务架构应用;
12.编程习惯优秀、代码规范、注重协作开发、负责组内代码review;
13.英文阅读能力良好，有阅读英文文档的习惯;
	
个人GitHub:
● JDK源码阅读注释笔记：https://github.com/BoulCheng/JDK8
● Elastic-Job源码阅读注释笔记：https://github.com/BoulCheng/elastic-job-2.1.5/tree/sourceCodeAnalysis
● Netty源码阅读注释笔记：https://github.com/BoulCheng/netty-4.1.36.Final/tree/develop
● Dubbo部分源码阅读注释笔记：https://github.com/BoulCheng/dubbo-2.6.4
● 设计模式Demo练习及心得总结笔记：https://github.com/BoulCheng/Head-First-Design-Patterns-Sample
● JVM笔记：https://github.com/BoulCheng/JVMS
● 算法Java实现练习代码：https://github.com/BoulCheng/algorithm-study
● elastic-job源码贡献 Pull requests : https://github.com/elasticjob/elastic-job-lite/pull/630    